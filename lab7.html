<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="style.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
  <script>hljs.highlightAll();</script>
  <title>Harlan Williams's Page</title>
</head>
<body>
  <header>
    <h1>EECS 348 Labs</h1>
    <ul>
      <li><a href="index.html">Index</a></li>
      <li><a href="lab1.html">Lab 1&mdash;Git and GitHub</a></li>
      <li><a href="lab2.html">Lab 2&mdash;Regular expressions</a></li>
      <li><a href="lab3.html">Lab 3&mdash;Makefiles</a></li>
      <li><a href="lab4.html">Lab 4&mdash;Web programming</a></li>
      <li><a href="lab5.html">Lab 5&mdash;UML use cases</a></li>
      <li><a href="lab6.html">Lab 6&mdash;UML class diagrams</a></li>
      <li><a href="lab7.html">Lab 7&mdash;C programming</a></li>
    </ul>
  </header>
  <main>
    <h1>Lab 7 &mdash; C programming</h1>
    <p>
      <a href="https://github.com/hrhwilliams/EECS348_Lab-7-template">Template for Lab 7</a> with instructions for how to begin. More experience with C programming, and with using continuous integration via GitHub Actions.
    </p>
    <h2>CMake and GitHub Action setup</h2>
    <p>
      The following is documentation for how the tests are set up with CMake and ran with GitHub Actions.
    </p>
    <p>
      The <code>CMakeLists.txt</code> at the root of the repository creates a library target named <code>libassignment</code>
      of all source files not containing the <code>main</code> function. This way any functions other than <code>main</code> are
      available to the executable made for running the unit tests in the <code>tests/</code> folder by linking to <code>libassignment</code>.

      It also adds <code>tests/</code> as a subdirectory so that when CMake is run, it will look in that directory for more build instructions.
    </p>
    <pre>
<code class="language-cmake">cmake_minimum_required(VERSION 3.13)
project(EECS348-Lab-7)

if (CMAKE_VERSION VERSION_GREATER_EQUAL "3.24.0")
    cmake_policy(SET CMP0135 NEW)
endif()

file(GLOB src *.c *.cpp)
list(FILTER src EXCLUDE REGEX ".*main\\.c(c|pp|xx)?")
add_subdirectory(tests)
add_library(assignment ${src})</code>
      </pre>
      <p>
        The <code>CMakeLists.txt</code> in <code>tests/</code> downloads the <code>googletest</code> repository and compiles it.
        It then compiles an executable with unit tests and links to <code>libassignment</code> to build your functions into the tests.
        The file mostly follows the example in <a href="https://google.github.io/googletest/quickstart-cmake.html">https://google.github.io/googletest/quickstart-cmake.html</a>.
      </p>
      <pre>
<code class="language-cmake">include(FetchContent)
FetchContent_Declare(
  googletest
  # branch 1.16.x
  URL https://github.com/google/googletest/archive/e88cb95b92acbdce9b058dd894a68e1281b38495.zip
)
FetchContent_MakeAvailable(googletest)

enable_testing()
add_executable(tests tests.cpp)
target_include_directories(tests PRIVATE ..)
target_link_libraries(tests assignment GTest::gtest_main)
include(GoogleTest)
gtest_discover_tests(tests)</code>
</pre>
<p>
  The workflow is found in <code>.github/workflows/gtest.yml</code>. It is triggered by any pushes to the <code>main</code> branch of your
  repository. Under <code>jobs</code> is the <code>test</code> job. It defines Ubuntu Linux as the environment to be ran in, and lists the
  steps to building and running googletest. Under the job named <code>Build googletest</code> are <code>cmake</code> instructions to execute the <code>CMakeLists.txt</code> files.
  Under the job named <code>Run googletest</code> is an export command to set the environment variable <code>GTEST_COLOR</code> to on, and then to change directory into
  the build directory and run the tests.
</p>
<pre>
  <code class="language-yaml">name: Test
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build googletest
        run: |
          cmake -S . -B build -DBUILD_GMOCK=OFF
          cmake --build build
      - name: Run googletest
        run: |
          export GTEST_COLOR=1
          cd build/tests && ctest --output-on-failure</code>
    </pre>
    <p>
      An example of a <emph>failing</emph> job run can be found at <a href="https://github.com/hrhwilliams/EECS348_Lab-7-template/actions/runs/13823097362/job/38672730358">https://github.com/hrhwilliams/EECS348_Lab-7-template/actions/runs/13823097362/job/38672730358</a>. There,
      if you look at the <code>Build googletest</code> step you can see a log reporting why the build failed. If you look at lines 36-38, and 40-43, you can see the build tool reports undefined
      references to all of the functions the test file wants to call, because none of them are defined yet in any of the <code>.c</code> files in the template.
    </p>
  </main>
</body>
</html>